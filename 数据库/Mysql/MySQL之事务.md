# 1. 数据库的事务
## 1.1. 定义
维基百科：
数据库事务（简称：事务）是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。
## 1.2. 哪些存储引擎支持事务
InnoDB支持事务
## 1.3. 事务的四大特性
- 原子性（Atomicity）：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行，在InnoDB中是通过undo log来实现，他记录了数据修改之前的值（逻辑日志），一旦发生异常，就可以用undo log来实现回滚操作
- 一致性（Consistency）：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数- 据库中的数据应满足完整性约束
- 隔离性（Isolation）：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。
- 持久性（Durability）：已被提交的事务对数据库的修改应该永久保存在数据库中。持久性是通过redo log来实现的，我们操作数据的时候，会先写到内存的buffer pool里面，同时记录redo log,如果刷盘之前出现异常，在重启后就可以读取redo log的内容，写入到磁盘，保证数据的持久性
## 1.4. 数据库什么时候出现事务
```
update user set name = "ada" where id = 1
```
- 他自动开启了一个事务，并且提交了（这是开启事务的第一种方式，自动开启和自动提交）
```
SHOW VARIABLES LIKE "autocommit"
```
可以看到：（默认值是ON）
![](_v_images/20200613135515948_25037.png =436x)
- 手动开启事务：一种是begin,另一种是start transaction
- 结束事务：第一种是commit ，另一种是rollback，回滚的时候，事务也会结束

## 1.5. 事务并发会带来啥问题
-  脏读（Dirty Read）
![](_v_images/20200613142655436_18549.png =1042x)

- 不可重复读（Unrepeatable Read）
![](_v_images/20200613142609092_7290.png =1020x)
-  幻读（Phantom Read）
![](_v_images/20200613142940571_20763.png =1022x)

# 2. 数据库的隔离级别
设置事务的隔离级别

- Read uncommitted: 未提交读，任何读问题解决不了的
- Read committed: 已提交读，加入写锁，解决脏读，但是不可重复读和虚读有可能发生
- Repeatable read: 重复读，加入读写锁，解决脏读和不可重复读，但是虚读有可能发生
- Serializable: 解决所有读问题
# 3. MySQL InnoDB对隔离级别的支持
![](_v_images/20200613143853027_3563.png =958x)
# 4. 两大实现方案
## 4.1. LBCC
第一种，读取数据的时候，锁定我们要操作的数据，不允许其他的事务修改就行，这种方案叫基于锁的并发控制（LBCC）
## 4.2. MVCC
- 在修改数据的时候给它建立一份备份或者叫快照，后面再来读取这个快照就行了，这种方案我们叫做多版本的并发控制（mvcc）
- MVCC的核心思想：我可以查到在我这个事务开始之前已经存在的已提交的数据，即使它在后面被修改或者删除了，在我这个事务之后新增的数据，我是查不到的
- InnoDB为每行记录都实现了两个隐藏的字段（还得加上一个rowid）
- - DB_TRX_ID(6个字节)，创建版本号，在数据新增或者修改的时候，记录当前事务ID
- - DB_ROLL_PTR（7个字节），回滚指针，删除版本号，数据被删除或者记录为旧数据的时候，记录当前事务ID
- 我们把这两个事务ID理解为版本号
